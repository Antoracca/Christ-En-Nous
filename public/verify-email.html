<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V√©rification Email - Christ en Nous</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #002366, #0052cc);
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      color: #333;
    }
    .container {
      background: white; border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px; width: 90%; padding: 50px 40px; text-align: center;
      position: relative; overflow: hidden;
    }
    .icon { font-size: 80px; margin-bottom: 20px; }
    .success { color: #4CAF50; animation: none; }
    .error { color: #f44336; animation: none; }
    .loading { color: #FFD700; animation: spin 1.5s linear infinite; }
    h1 { color: #002366; margin-bottom: 20px; font-size: 28px; }
    p { color: #666; line-height: 1.6; margin-bottom: 30px; font-size: 16px; }
    .button {
      display: inline-block; padding: 15px 40px;
      background: linear-gradient(135deg, #FFD700, #FFC500);
      color: #002366; text-decoration: none;
      border-radius: 30px; font-weight: bold; font-size: 16px;
      box-shadow: 0 5px 20px rgba(255,215,0,0.4);
      transition: all 0.3s ease;
    }
    .button:hover { transform: translateY(-2px); }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="content">
      <div class="icon loading">‚è≥</div>
      <h1>V√©rification en cours...</h1>
      <p>Nous validons votre lien, veuillez patienter.</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCIUcMu5xi_UUVfUn1twv8F6jLqYOeAylE",
      authDomain: "app-christ-en-nous.firebaseapp.com",
      projectId: "app-christ-en-nous",
      storageBucket: "app-christ-en-nous.appspot.com",
      messagingSenderId: "774503250388",
      appId: "1:774503250388:web:932b03c828bc58264f3e41"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    async function verifyEmail() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        console.log(`[DEV] üîç Token r√©cup√©r√©: ${token}`);
        
        if (!token) {
          return showError('Lien invalide', 'Aucun token trouv√© dans l\'URL.');
        }

        console.log('[DEV] üîê Tentative de connexion anonyme pour obtenir les permissions...');
        await signInAnonymously(auth);
        console.log('[DEV] ‚úÖ Connexion anonyme r√©ussie.');
        
        // --- La logique de v√©rification commence ici ---
        console.log('[DEV] üìñ Lecture du token dans Firestore...');
        const tokenRef = doc(db, 'email_verifications', token);
        const tokenDoc = await getDoc(tokenRef);
        
        if (!tokenDoc.exists()) {
          console.error('[DEV] ‚ùå Le document du token n\'existe pas.');
          return showError('Lien invalide', 'Ce lien n\'existe pas ou a d√©j√† √©t√© utilis√©.');
        }

        const tokenData = tokenDoc.data();
        console.log('[DEV] üìã Donn√©es du token r√©cup√©r√©es:', tokenData);
        
        if (tokenData.used) {
          console.warn('[DEV] ‚ö†Ô∏è Ce token a d√©j√† √©t√© utilis√©.');
          return showAlreadyVerified();
        }

        const expiresAt = new Date(tokenData.expiresAt);
        if (expiresAt < new Date()) {
          console.error('[DEV] ‚ùå Ce token a expir√©.');
          return showError('Lien expir√©', 'Pour votre s√©curit√©, ce lien de v√©rification a expir√©. Veuillez en demander un nouveau.');
        }

        console.log('[DEV] üíæ Mise √† jour du profil utilisateur...');
        await updateDoc(doc(db, 'users', tokenData.userId), {
          emailVerified: true,
          emailVerifiedAt: new Date().toISOString()
        });
        console.log('[DEV] ‚úÖ Profil utilisateur mis √† jour.');

        console.log('[DEV] üîí Marquage du token comme utilis√©...');
        await updateDoc(tokenRef, {
          used: true,
          usedAt: new Date().toISOString()
        });
        console.log('[DEV] ‚úÖ Token marqu√© comme utilis√©.');

        // Si tout s'est bien pass√©
        showSuccess();

      } catch (error) {
        console.error('[DEV] ‚ùå Erreur globale dans le processus de v√©rification:', error);
        
        if (error.code === 'permission-denied') {
          showError('Probl√®me de Permissions', 'La configuration de s√©curit√© de la base de donn√©es emp√™che cette op√©ration. Veuillez contacter le support technique.');
        } else {
          showError('Erreur Technique', 'Une erreur inattendue est survenue. Veuillez r√©essayer ou contacter le support.');
        }
      }
    }

    // --- Fonctions d'affichage (inchang√©es) ---
    function showSuccess() {
      document.getElementById('content').innerHTML = `
        <div class="icon success">‚úÖ</div>
        <h1>Email confirm√© !</h1>
        <p>F√©licitations ! Votre adresse email a √©t√© v√©rifi√©e avec succ√®s.</p>
        <a href="#" class="button" onclick="openApp()">Ouvrir l'application</a>
      `;
    }

    function showAlreadyVerified() {
      document.getElementById('content').innerHTML = `
        <div class="icon success">‚úì</div>
        <h1>D√©j√† v√©rifi√©</h1>
        <p>Votre email a d√©j√† √©t√© confirm√© pr√©c√©demment. Tout est en ordre !</p>
        <a href="#" class="button" onclick="openApp()">Ouvrir l'application</a>
      `;
    }

    function showError(title, message) {
      document.getElementById('content').innerHTML = `
        <div class="icon error">‚ùå</div>
        <h1>${title}</h1>
        <p>${message}</p>
        <a href="#" class="button" onclick="openApp()">Retour √† l'application</a>
      `;
    }

    window.openApp = function() {
      window.location.href = 'christennous://verified';
      setTimeout(() => { window.location.href = 'https://christennous.com'; }, 2000);
    }

    // üöÄ D√©marrage du processus au chargement de la page
    verifyEmail();
  </script>
</body>
</html>